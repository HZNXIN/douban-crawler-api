# 🚀 部署指南 - 5分钟完成

## 方式一：通过 Vercel 网站部署（推荐）⭐

### 步骤1：准备代码

1. 在GitHub上创建新仓库 `douban-crawler-api`
2. 上传以下文件：
   - `api/index.js`
   - `vercel.json`
   - `package.json`

### 步骤2：导入到 Vercel

1. 访问：https://vercel.com
2. 点击「New Project」
3. 选择「Import Git Repository」
4. 选择你刚创建的仓库
5. 点击「Deploy」

### 步骤3：完成！

部署完成后，你会得到一个域名，类似：
```
https://douban-crawler-api.vercel.app
```

### 步骤4：测试API

在浏览器访问：
```
https://你的域名.vercel.app/in_theaters
https://你的域名.vercel.app/coming_soon
https://你的域名.vercel.app/top250
```

---

## 方式二：通过 Vercel CLI 部署

### 步骤1：安装 Vercel CLI

```bash
npm install -g vercel
```

### 步骤2：登录

```bash
vercel login
```

### 步骤3：部署

在项目文件夹中执行：
```bash
vercel
```

按提示操作即可。

### 步骤4：生产部署

```bash
vercel --prod
```

---

## 🔧 在小程序中使用

### 修改 app.js

```javascript
globalData: {
  apiConfig: {
    currentApi: 'custom',
    
    custom: {
      baseUrl: 'https://你的域名.vercel.app'  // 替换为你的域名
    }
  }
}
```

### 修改 pages/index/index.js

在 `loadMovies` 函数中：

```javascript
// 如果使用自定义API
if (app.globalData.apiConfig.currentApi === 'custom') {
  const baseUrl = app.globalData.apiConfig.custom.baseUrl
  
  wx.request({
    url: `${baseUrl}/${type}`,
    data: {
      start: (page - 1) * pageSize,
      count: pageSize
    },
    success: (res) => {
      // 处理数据...
    }
  })
}
```

---

## 📊 API 端点

### 1. 正在热映
```
GET /in_theaters?start=0&count=10
```

### 2. 即将上映
```
GET /coming_soon?start=0&count=10
```

### 3. Top250
```
GET /top250?start=0&count=10
```

### 返回格式
```json
{
  "count": 10,
  "start": 0,
  "total": 250,
  "subjects": [
    {
      "id": "1292052",
      "title": "肖申克的救赎",
      "rating": { "average": 9.7 },
      "year": "1994",
      "images": { "large": "..." },
      "genres": ["剧情", "犯罪"],
      "directors": [{ "name": "弗兰克·德拉邦特" }],
      "casts": [{ "name": "蒂姆·罗宾斯" }],
      "genresText": "剧情 / 犯罪",
      "directorName": "弗兰克·德拉邦特",
      "castsText": "蒂姆·罗宾斯 / 摩根·弗里曼"
    }
  ],
  "title": "正在热映"
}
```

---

## ⚙️ 特性

### 1. 自动缓存
- 缓存时间：1小时
- 减少对豆瓣的请求频率
- 提高响应速度

### 2. 降级处理
- 爬取失败时返回缓存数据
- 无缓存时返回模拟数据
- 确保API始终可用

### 3. CORS支持
- 允许跨域请求
- 小程序可直接调用

### 4. 超时保护
- 10秒超时限制
- 避免长时间等待

---

## 🔍 测试

### 本地测试

```bash
vercel dev
```

然后访问：
```
http://localhost:3000/in_theaters
```

### 生产测试

部署后访问：
```
https://你的域名.vercel.app/in_theaters
```

---

## 💡 优化建议

### 1. 添加请求限流

防止被豆瓣封IP：
```javascript
// 记录请求次数
let requestCount = 0;
let resetTime = Date.now();

if (Date.now() - resetTime > 60000) {
  requestCount = 0;
  resetTime = Date.now();
}

if (requestCount > 10) {
  return res.status(429).json({ error: '请求过于频繁' });
}

requestCount++;
```

### 2. 使用数据库缓存

Vercel KV 或 MongoDB：
```javascript
// 存储到持久化数据库
await kv.set(`movies:${endpoint}`, result, { ex: 3600 });
```

### 3. 定时更新

使用 Vercel Cron Jobs 定时爬取：
```json
{
  "crons": [{
    "path": "/api/update",
    "schedule": "0 */6 * * *"
  }]
}
```

---

## 🐛 常见问题

### Q: 爬取失败怎么办？
A: API会自动返回缓存数据或模拟数据，不影响使用

### Q: Vercel 免费版够用吗？
A: 完全够用！100GB流量/月，10万次请求/月

### Q: 会被豆瓣封IP吗？
A: 添加了缓存和User-Agent，正常使用不会

### Q: 如何更新API？
A: 修改代码后，push到GitHub，Vercel自动重新部署

---

## 📝 下一步

1. ✅ 部署到Vercel
2. ✅ 获取API域名
3. ✅ 在小程序中配置
4. ✅ 测试功能
5. ✅ 享受稳定的API服务！

---

**现在就开始部署，5分钟后拥有自己的豆瓣API！** 🎉

