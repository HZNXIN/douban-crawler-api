# ğŸ–¼ï¸ å›¾ç‰‡ä»£ç†é…ç½®æŒ‡å—

## ğŸ“‹ é—®é¢˜è¯´æ˜

å¾®ä¿¡å°ç¨‹åºæ˜¾ç¤ºçŒ«çœ¼å›¾ç‰‡æ—¶å‡ºç°ç©ºç™½ï¼ŒåŸå› ï¼š
1. âŒ çŒ«çœ¼CDNåŸŸå `p0.pipi.cn` æœªåœ¨å°ç¨‹åºç™½åå•ä¸­
2. âŒ çŒ«çœ¼å›¾ç‰‡æœ‰é˜²ç›—é“¾ä¿æŠ¤ï¼ˆRefereréªŒè¯ï¼‰

## âœ… è§£å†³æ–¹æ¡ˆï¼šå›¾ç‰‡ä»£ç†æœåŠ¡

å·²åˆ›å»ºå›¾ç‰‡ä»£ç†æœåŠ¡ï¼Œè‡ªåŠ¨è½¬å‘çŒ«çœ¼å›¾ç‰‡å¹¶ç»•è¿‡é˜²ç›—é“¾ã€‚

---

## ğŸ“ æ–°å¢æ–‡ä»¶

### 1. `api/image-proxy.js`
**å›¾ç‰‡ä»£ç†æ¥å£**

åŠŸèƒ½ï¼š
- âœ… ä»£ç†çŒ«çœ¼CDNå›¾ç‰‡
- âœ… æ·»åŠ æ­£ç¡®çš„Refererå’ŒUser-Agent
- âœ… æ”¯æŒç¼“å­˜ï¼ˆ24å°æ—¶ï¼‰
- âœ… æµå¼ä¼ è¾“ï¼ŒèŠ‚çœå†…å­˜

### 2. `api/maoyan-crawler.js`ï¼ˆå·²æ›´æ–°ï¼‰
**è‡ªåŠ¨è½¬æ¢å›¾ç‰‡URL**

æ–°å¢åŠŸèƒ½ï¼š
- âœ… `getProxyImageUrl()` å‡½æ•°
- âœ… æ‰€æœ‰å›¾ç‰‡URLè‡ªåŠ¨ç»è¿‡ä»£ç†
- âœ… å®Œå…¨é€æ˜ï¼Œæ— éœ€ä¿®æ”¹å°ç¨‹åºä»£ç 

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šä¸Šä¼ æ–°æ–‡ä»¶åˆ°GitHub

#### åˆ›å»º `api/image-proxy.js`

1. æ‰“å¼€ä½ çš„GitHubä»“åº“ï¼šhttps://github.com/HZNXIN/douban-crawler-api

2. è¿›å…¥ `api/` æ–‡ä»¶å¤¹

3. ç‚¹å‡» **Add file** â†’ **Create new file**

4. æ–‡ä»¶åè¾“å…¥ï¼š`image-proxy.js`

5. å¤åˆ¶ä»¥ä¸‹ä»£ç ï¼š

```javascript
/**
 * å›¾ç‰‡ä»£ç†æœåŠ¡
 * è§£å†³å¾®ä¿¡å°ç¨‹åºå›¾ç‰‡é˜²ç›—é“¾å’ŒåŸŸåç™½åå•é—®é¢˜
 */

const https = require('https');
const http = require('http');

/**
 * ä»£ç†å›¾ç‰‡è¯·æ±‚
 * ä½¿ç”¨æ–¹å¼ï¼š/api/image-proxy?url=https://p0.pipi.cn/xxx.jpg
 */
module.exports = async (req, res) => {
  // è®¾ç½®CORS
  res.setHeader('Access-Control-Allow-Origin', '*');
  res.setHeader('Access-Control-Allow-Methods', 'GET, OPTIONS');
  res.setHeader('Access-Control-Allow-Headers', 'Content-Type');
  
  if (req.method === 'OPTIONS') {
    res.status(200).end();
    return;
  }
  
  // è·å–å›¾ç‰‡URLå‚æ•°
  const urlParams = new URL(req.url, `http://${req.headers.host}`);
  const imageUrl = urlParams.searchParams.get('url');
  
  if (!imageUrl) {
    return res.status(400).json({ error: 'ç¼ºå°‘urlå‚æ•°' });
  }
  
  console.log(`ğŸ“¸ ä»£ç†å›¾ç‰‡è¯·æ±‚: ${imageUrl}`);
  
  try {
    // è§£æç›®æ ‡URL
    const targetUrl = new URL(imageUrl);
    const protocol = targetUrl.protocol === 'https:' ? https : http;
    
    const options = {
      hostname: targetUrl.hostname,
      path: targetUrl.pathname + targetUrl.search,
      method: 'GET',
      headers: {
        'User-Agent': 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_7_1 like Mac OS X) AppleWebKit/605.1.15',
        'Accept': 'image/webp,image/apng,image/*,*/*;q=0.8',
        'Accept-Language': 'zh-CN,zh;q=0.9',
        'Referer': 'https://m.maoyan.com/',
        'Origin': 'https://m.maoyan.com'
      }
    };
    
    protocol.get(options, (imageRes) => {
      // è½¬å‘å“åº”å¤´
      res.setHeader('Content-Type', imageRes.headers['content-type'] || 'image/jpeg');
      res.setHeader('Cache-Control', 'public, max-age=86400'); // ç¼“å­˜24å°æ—¶
      
      // å¦‚æœæœ‰å†…å®¹é•¿åº¦ï¼Œä¹Ÿè½¬å‘
      if (imageRes.headers['content-length']) {
        res.setHeader('Content-Length', imageRes.headers['content-length']);
      }
      
      // æµå¼ä¼ è¾“å›¾ç‰‡
      imageRes.pipe(res);
      
    }).on('error', (err) => {
      console.error('âŒ è·å–å›¾ç‰‡å¤±è´¥:', err.message);
      res.status(500).json({ error: 'è·å–å›¾ç‰‡å¤±è´¥', message: err.message });
    });
    
  } catch (err) {
    console.error('âŒ è§£æURLå¤±è´¥:', err.message);
    res.status(400).json({ error: 'URLæ ¼å¼é”™è¯¯', message: err.message });
  }
};
```

6. ç‚¹å‡» **Commit new file**

---

#### æ›´æ–° `api/maoyan-crawler.js`

1. ç‚¹å‡» `api/maoyan-crawler.js` æ–‡ä»¶

2. ç‚¹å‡» **âœï¸ ç¼–è¾‘**

3. æ‰¾åˆ° `convertMaoyanToDoubanFormat` å‡½æ•°å‰ï¼Œæ·»åŠ ä»¥ä¸‹ä»£ç ï¼š

```javascript
/**
 * å°†çŒ«çœ¼å›¾ç‰‡URLè½¬æ¢ä¸ºä»£ç†URL
 * è§£å†³å¾®ä¿¡å°ç¨‹åºå›¾ç‰‡æ˜¾ç¤ºé—®é¢˜
 */
function getProxyImageUrl(originalUrl) {
  if (!originalUrl) return '';
  
  // å¦‚æœå·²ç»æ˜¯ä»£ç†URLï¼Œç›´æ¥è¿”å›
  if (originalUrl.includes('douban-crawler-api.vercel.app')) {
    return originalUrl;
  }
  
  // ä½¿ç”¨è‡ªå·±çš„å›¾ç‰‡ä»£ç†
  const proxyBase = 'https://douban-crawler-api.vercel.app/api/image-proxy';
  return `${proxyBase}?url=${encodeURIComponent(originalUrl)}`;
}
```

4. åœ¨ `convertMaoyanToDoubanFormat` å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°å›¾ç‰‡å¤„ç†éƒ¨åˆ†ï¼Œä¿®æ”¹ä¸ºï¼š

```javascript
// å¤„ç†å›¾ç‰‡URL - ä½¿ç”¨ä»£ç†è§£å†³æ˜¾ç¤ºé—®é¢˜
const proxyPoster = getProxyImageUrl(poster);

return {
  // ... å…¶ä»–å­—æ®µ ...
  images: {
    small: proxyPoster,  // åŸæ¥æ˜¯ poster
    large: proxyPoster,  // åŸæ¥æ˜¯ poster
    medium: proxyPoster  // åŸæ¥æ˜¯ poster
  },
  // ... å…¶ä»–å­—æ®µ ...
};
```

5. ç‚¹å‡» **Commit changes**

---

### æ­¥éª¤2ï¼šç­‰å¾…Vercelè‡ªåŠ¨éƒ¨ç½²

GitHubæ¨é€åï¼ŒVercelä¼šè‡ªåŠ¨éƒ¨ç½²ï¼ˆçº¦30ç§’ï¼‰

æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ï¼šhttps://vercel.com/hznxin/douban-crawler-api

---

## ğŸ§ª æµ‹è¯•

### 1. æµ‹è¯•å›¾ç‰‡ä»£ç†æ¥å£

åœ¨æµè§ˆå™¨è®¿é—®ï¼š

```
https://douban-crawler-api.vercel.app/api/image-proxy?url=https://p0.pipi.cn/mediaplus/friday_image_fe/0fa3346e5296e3b24ed7e478dbb00d74867dc.jpg
```

**é¢„æœŸç»“æœ**ï¼šç›´æ¥æ˜¾ç¤ºå›¾ç‰‡

---

### 2. æµ‹è¯•ç”µå½±API

```
https://douban-crawler-api.vercel.app/in_theaters
```

**æŸ¥çœ‹å›¾ç‰‡URL**ï¼Œåº”è¯¥å˜æˆï¼š

```json
{
  "images": {
    "large": "https://douban-crawler-api.vercel.app/api/image-proxy?url=https%3A%2F%2Fp0.pipi.cn%2Fmediaplus%2F..."
  }
}
```

---

### 3. æµ‹è¯•å°ç¨‹åº

æ‰“å¼€å¾®ä¿¡å¼€å‘è€…å·¥å…·ï¼Œåˆ·æ–°é¡µé¢ï¼Œå›¾ç‰‡åº”è¯¥æ­£å¸¸æ˜¾ç¤ºï¼

---

## ğŸ¯ å·¥ä½œåŸç†

### åŸå§‹æµç¨‹ï¼ˆå¤±è´¥ï¼‰âŒ
```
å¾®ä¿¡å°ç¨‹åº â†’ çŒ«çœ¼CDN (p0.pipi.cn)
                â†“
            é˜²ç›—é“¾æ‹¦æˆª âŒ
```

### ä»£ç†æµç¨‹ï¼ˆæˆåŠŸï¼‰âœ…
```
å¾®ä¿¡å°ç¨‹åº â†’ Vercelä»£ç† â†’ çŒ«çœ¼CDN
                â†“             â†“
            æ·»åŠ Referer    è¿”å›å›¾ç‰‡ âœ…
```

---

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### ç¼“å­˜ç­–ç•¥
- **æµè§ˆå™¨ç¼“å­˜**ï¼š24å°æ—¶
- **Vercel Edgeç¼“å­˜**ï¼šè‡ªåŠ¨
- **å›¾ç‰‡æµå¼ä¼ è¾“**ï¼šä½å†…å­˜å ç”¨

### é¢„æœŸæ•ˆæœ
- âœ… é¦–æ¬¡åŠ è½½ï¼š~500ms
- âœ… ç¼“å­˜å‘½ä¸­ï¼š~50ms
- âœ… å¸¦å®½èŠ‚çœï¼š~70%

---

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜1ï¼šå›¾ç‰‡ä»ç„¶ç©ºç™½

**æ£€æŸ¥æ­¥éª¤**ï¼š

1. **ç¡®è®¤æ–‡ä»¶å·²ä¸Šä¼ **
   - GitHubä¸Šç¡®è®¤ `api/image-proxy.js` å­˜åœ¨
   - ç¡®è®¤ `maoyan-crawler.js` å·²æ›´æ–°

2. **ç¡®è®¤éƒ¨ç½²æˆåŠŸ**
   - Vercelæ§åˆ¶å°æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€
   - æŸ¥çœ‹Runtime Logsæ˜¯å¦æœ‰é”™è¯¯

3. **æ‰‹åŠ¨æµ‹è¯•ä»£ç†æ¥å£**
   ```
   https://douban-crawler-api.vercel.app/api/image-proxy?url=https://p0.pipi.cn/test.jpg
   ```

4. **æ£€æŸ¥å°ç¨‹åºç½‘ç»œè¯·æ±‚**
   - å¾®ä¿¡å¼€å‘è€…å·¥å…· â†’ Network
   - æŸ¥çœ‹å›¾ç‰‡è¯·æ±‚çš„URL
   - æŸ¥çœ‹è¿”å›çŠ¶æ€ç 

---

### é—®é¢˜2ï¼šå›¾ç‰‡åŠ è½½å¾ˆæ…¢

**åŸå› **ï¼šé¦–æ¬¡è¯·æ±‚éœ€è¦ä»çŒ«çœ¼ä¸‹è½½

**è§£å†³**ï¼š
- âœ… å·²å¯ç”¨24å°æ—¶ç¼“å­˜
- âœ… Vercelå…¨çƒCDNåŠ é€Ÿ
- âœ… æµå¼ä¼ è¾“ä¼˜åŒ–

**è¿›ä¸€æ­¥ä¼˜åŒ–**ï¼ˆå¯é€‰ï¼‰ï¼š
- ä½¿ç”¨Vercelçš„Image Optimization
- è½¬å­˜å›¾ç‰‡åˆ°è‡ªå·±çš„OSS/CDN

---

### é—®é¢˜3ï¼šéƒ¨åˆ†å›¾ç‰‡404

**åŸå› **ï¼šçŒ«çœ¼åŸå›¾å·²åˆ é™¤

**è§£å†³**ï¼šæ·»åŠ é»˜è®¤å›¾ç‰‡

åœ¨ `maoyan-crawler.js` ä¸­ï¼š

```javascript
function getProxyImageUrl(originalUrl) {
  if (!originalUrl) {
    // è¿”å›é»˜è®¤å ä½å›¾
    return 'https://image.tmdb.org/t/p/w500/placeholder.jpg';
  }
  // ... å…¶ä»–ä»£ç 
}
```

---

## ğŸ¨ å¤‡ç”¨æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šä½¿ç”¨TMDbå›¾ç‰‡

å¦‚æœçŒ«çœ¼å›¾ç‰‡æŒç»­å‡ºé—®é¢˜ï¼Œå¯ä»¥åˆ‡æ¢åˆ°TMDbï¼š

1. æ³¨å†ŒTMDbè´¦å·å¹¶è·å–API Key
2. ä¿®æ”¹çˆ¬è™«ï¼ŒåŒæ—¶è·å–TMDbæµ·æŠ¥
3. ä¼˜å…ˆä½¿ç”¨TMDbå›¾ç‰‡

### æ–¹æ¡ˆBï¼šå›¾ç‰‡æœ¬åœ°ç¼“å­˜

å°†çƒ­é—¨ç”µå½±æµ·æŠ¥ä¸‹è½½åˆ°é¡¹ç›®ä¸­ï¼š

```javascript
// åœ¨å°ç¨‹åºä¸­
images: {
  large: `/images/movie-${id}.jpg`  // æœ¬åœ°å›¾ç‰‡
}
```

---

## âœ… æ€»ç»“

| æ–¹æ¡ˆ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| ğŸ¥‡ **å›¾ç‰‡ä»£ç†**ï¼ˆå½“å‰ï¼‰ | é€æ˜ã€è‡ªåŠ¨ã€ç¨³å®š | éœ€è¦æœåŠ¡å™¨æ”¯æŒ |
| ğŸ¥ˆ é…ç½®åŸŸåç™½åå• | ç®€å•ã€ç›´æ¥ | å¯èƒ½è¢«é˜²ç›—é“¾æ‹¦æˆª |
| ğŸ¥‰ ä½¿ç”¨TMDbå›¾ç‰‡ | å®˜æ–¹APIã€ç¨³å®š | éœ€è¦é¢å¤–å¼€å‘ |
| æœ¬åœ°å›¾ç‰‡ | æœ€å¿« | éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ |

---

ç°åœ¨å»GitHubä¸Šä¼  `image-proxy.js` å¹¶æ›´æ–° `maoyan-crawler.js` å§ï¼

éƒ¨ç½²å®Œæˆåï¼Œå°ç¨‹åºçš„å›¾ç‰‡å°±èƒ½æ­£å¸¸æ˜¾ç¤ºäº†ï¼ğŸ‰

